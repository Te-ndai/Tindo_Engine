#!/usr/bin/env bash
set -euo pipefail

python3 - <<'PY'
import json, hashlib, os, sys
from datetime import datetime, timezone

SRC="runtime/state/logs/executions.jsonl"
CHAIN="runtime/state/logs/executions.chain.jsonl"
CP="runtime/state/logs/executions.chain.checkpoint.json"

if os.path.exists(CP):
    print("ERROR: checkpoint exists; init refused")
    sys.exit(3)

if not os.path.exists(SRC):
    print("ERROR: source log missing:", SRC)
    sys.exit(3)

def canon(ev: dict) -> bytes:
    ev2=dict(ev)
    ev2.pop("prev_sha256", None)
    ev2.pop("line_sha256", None)
    return json.dumps(ev2, sort_keys=True, separators=(",",":")).encode("utf-8")

# Load source events
raw=[l for l in open(SRC,"r",encoding="utf-8").read().splitlines() if l.strip()]
events=[json.loads(l) for l in raw]

# Build chain
prev="0"*64
n=0
with open(CHAIN+".tmp","w",encoding="utf-8") as fout:
    for ev in events:
        payload=canon(ev)
        h=hashlib.sha256(prev.encode("utf-8")+payload).hexdigest()
        ev2=json.loads(payload.decode("utf-8"))
        ev2["prev_sha256"]=prev
        ev2["line_sha256"]=h
        fout.write(json.dumps(ev2, sort_keys=True) + "\n")
        prev=h
        n+=1
os.replace(CHAIN+".tmp", CHAIN)

# Prefix digest of source up to N (entire current file)
pref=hashlib.sha256()
for ev in events:
    pref.update(canon(ev))
prefix_sha=pref.hexdigest()

ck={
  "lines": n,
  "last_line_sha256": prev if n>0 else "0"*64,
  "source_prefix_sha256": prefix_sha,
  "checkpoint_time_utc": datetime.now(timezone.utc).strftime("%Y-%m-%dT%H:%M:%SZ")
}
with open(CP+".tmp","w",encoding="utf-8") as f:
    json.dump(ck, f, indent=2, sort_keys=True); f.write("\n")
os.replace(CP+".tmp", CP)

print("OK: init complete lines=", n)
PY
