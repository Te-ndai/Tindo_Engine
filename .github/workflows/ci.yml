name: CI

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  # ------------------------------------------------------------------
  # Phase 90 — Deterministic proof chain
  # ------------------------------------------------------------------
  deterministic-proof:
    name: Phase 90 – Deterministic proof
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Ensure scripts executable
        run: |
          chmod +x test/*.sh runtime/bin/* build/*.sh populate/*.sh || true

      - name: Run deterministic proof chain
        env:
          FACTORY_VERSION: "ci"
          RUNTIME_VERSION: "ci"
        run: |
          ./test/90_test_all_deterministic.sh

      - name: Upload release artifacts (latest)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: runtime-releases
          path: runtime/state/releases
          if-no-files-found: warn


  # ------------------------------------------------------------------
  # Phase 105B — Sign minted releases (CI)
  # ------------------------------------------------------------------
  sign-releases:
    name: Phase 105B – Sign minted releases (CI)
    runs-on: ubuntu-latest
    needs: [deterministic-proof]

    # Secrets MUST only exist on trusted pushes
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    # Option A: environment-scoped secrets
    environment: ci

    # Inject secret at JOB scope (visible to all steps)
    env:
      RELEASE_SIGNING_KEY_PEM: ${{ secrets.RELEASE_SIGNING_KEY_PEM }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download minted release artifacts
        uses: actions/download-artifact@v4
        with:
          name: runtime-releases
          path: runtime/state/releases

      - name: Ensure signing tools executable
        run: |
          chmod +x runtime/bin/ci_sign_releases || true
          chmod +x runtime/bin/attach_release_signatures || true
          chmod +x runtime/bin/verify_release_signatures || true
          chmod +x runtime/bin/validate_manifest || true
          chmod +x runtime/bin/sign_detached runtime/bin/verify_detached || true

      - name: Preflight signing key
        shell: bash
        run: |
          set -euo pipefail
          if [[ -z "${RELEASE_SIGNING_KEY_PEM:-}" ]]; then
            echo "ERROR: RELEASE_SIGNING_KEY_PEM is empty." >&2
            exit 2
          fi
          if ! printf "%s" "$RELEASE_SIGNING_KEY_PEM" | grep -q "BEGIN"; then
            echo "ERROR: RELEASE_SIGNING_KEY_PEM is not a PEM." >&2
            exit 3
          fi

      - name: Sign releases (no minting)
        run: |
          ./runtime/bin/ci_sign_releases runtime/state/releases

      - name: Signature report (post-sign)
        run: |
          chmod +x runtime/bin/signature_report || true
          ./runtime/bin/signature_report > signature_report_after_sign.txt
          cat signature_report_after_sign.txt

      - name: Upload signed releases
        uses: actions/upload-artifact@v4
        with:
          name: runtime-releases-signed
          path: runtime/state/releases

      - name: Upload signature report (after sign)
        uses: actions/upload-artifact@v4
        with:
          name: signature-report-after-sign
          path: signature_report_after_sign.txt


  # ------------------------------------------------------------------
  # Phase 103 — Hygiene report (dry-run)
  # ------------------------------------------------------------------
  hygiene-report:
    name: Phase 103 – Hygiene report (dry-run)
    runs-on: ubuntu-latest
    needs: [deterministic-proof]

    steps:
      - uses: actions/checkout@v4

      - name: Ensure scripts executable
        run: |
          chmod +x patch102_hygiene.sh || true
          chmod +x runtime/bin/validate_manifest || true

      - name: Run hygiene (dry-run only)
        run: |
          ./patch102_hygiene.sh --dry-run
          test -f runtime/state/reports/phase102_hygiene_latest.txt

      - name: Upload hygiene report
        uses: actions/upload-artifact@v4
        with:
          name: hygiene-report
          path: runtime/state/reports/phase102_hygiene_latest.txt


  # ------------------------------------------------------------------
  # Phase 96 — Manifest portability report (3-tier policy)
  # ------------------------------------------------------------------
  manifest-portability-report:
    name: Phase 96 – Manifest portability report
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Ensure validator executable
        run: |
          chmod +x runtime/bin/validate_manifest || true

      - name: Generate portability report (Phase 96 – Option C)
        run: |
          python3 - <<'PY' > portability_report.txt
          import glob, json, platform, re, subprocess, sys

          STRICT_KEYS = ("os","arch","python","impl","machine")
          RELAX_KEYS  = ("os","arch","python","impl")

          def host():
              return {
                  "os": platform.system().lower(),
                  "arch": platform.machine().lower(),
                  "python": platform.python_version(),
                  "impl": platform.python_implementation().lower(),
                  "machine": platform.platform(),
              }

          host_full = host()
          host_relax = {k: host_full[k] for k in RELAX_KEYS}

          manifests = sorted(glob.glob("runtime/state/releases/release_*.json"))
          if not manifests:
              print("No manifests found.")
              sys.exit(0)

          portable_strict = []
          portable_relaxed = []
          host_bound = []
          invalid = []

          def rid(p):
              m = re.search(r"release_(\d{8}T\d{6}Z)\.json$", p)
              return m.group(1) if m else ""

          for mpath in manifests:
              r = rid(mpath)
              cmd = ["./runtime/bin/validate_manifest", mpath]
              if r:
                  cmd += ["--release-id", r]
              try:
                  subprocess.check_output(cmd, stderr=subprocess.STDOUT)
              except subprocess.CalledProcessError as e:
                  invalid.append((mpath, e.output.decode()))
                  continue

              doc = json.load(open(mpath))
              compat = doc.get("compat") or {}

              strict = {k: compat.get(k) for k in STRICT_KEYS}
              relax  = {k: compat.get(k) for k in RELAX_KEYS}

              if strict == host_full:
                  portable_strict.append(mpath)
              elif relax == host_relax:
                  portable_relaxed.append(mpath)
              else:
                  host_bound.append(mpath)

          print("PORTABLE_STRICT:", len(portable_strict))
          print("PORTABLE_RELAXED:", len(portable_relaxed))
          print("HOST_BOUND:", len(host_bound))
          print("INVALID:", len(invalid))

          if invalid:
              sys.exit(2)
          PY
          cat portability_report.txt

      - name: Upload portability report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: portability-report
          path: portability_report.txt



  # ------------------------------------------------------------------
  # Phase 104 — Signature verification report (read-only)
  # ------------------------------------------------------------------
  signature-report:
    name: Phase 104 – Signature verification report
    runs-on: ubuntu-latest
    needs: [deterministic-proof]

    steps:
      - uses: actions/checkout@v4

      - name: Ensure tools executable
        run: |
          chmod +x runtime/bin/signature_report || true
          chmod +x runtime/bin/verify_release_signatures || true

      - name: Generate signature report
        run: |
          ./runtime/bin/signature_report > signature_report.txt
          cat signature_report.txt

      - name: Upload signature report
        uses: actions/upload-artifact@v4
        with:
          name: signature-report
          path: signature_report.txt
